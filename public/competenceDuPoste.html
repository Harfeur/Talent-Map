<!doctype html>
<html>
<meta charset="utf-8">
<title>Chercher une compétence</title>
<meta name="description" content="???">
<link rel="stylesheet" type="text/css" href="/packages/bootstrap/dist/css/bootstrap.css" />
<script src="/packages/jquery/dist/jquery.min.js"></script>
<script src="/packages/angular/angular.min.js"></script>
<script src="/packages/bootstrap/dist/js/bootstrap.js"></script>
</head>

<body ng-app="gpecApp" ng-controller="controleur">
  <div include-html="navbar.html"></div>
  <div class="container">

    <h1>Chercher un poste</h1>
    <form>
      <label for="taux">Taux</label>
      <input id="taux" type="number" min=0>
    </form>
    <div class="row">
      <div class="col-6">
        <div class="tab-content" id="myTabContent">
          <form class="form-inline my-4" id="chposte">
            <label for="listePostes">Poste à afficher</label>
            <select class="form-control mx-2" id="listePostes">
              <option selected disabled></option>
            </select>
          </form>
          <table id="tabResulPoste" class="table">
          </table>
        </div>
      </div>
      <div class="col-6">
        <div class="tab-content" id="myTabContent">
          <form class="form-inline my-4" id="chpersos">
            <label for="listePersos">Personnel à afficher</label>
            <select class="form-control mx-2" id="listePersos">
              <option selected disabled></option>
            </select>
          </form>
          <table id="tabResulPerso" class="table">
          </table>
        </div>
      </div>
    </div>
  </div>
  <script src="js/include-html.js"></script>
</body>
<script>
  let taux = 5;
  let competencesPoste = []

  function remplirChoixFormation(id) {
    $.ajax({
      method: 'GET',
      url: 'suggestFormation/',
      dataType: 'json',
      data: {
        "id": id
      },
      success: function (data) {
        data.forEach(d => {
          $(`#choix-form-${id}`).append(`<option data-id=${d.id}>${d.libelle}</option>`);
        });
      },
      error: function (x, error) {
        console.log(error);
      }
    });
  }

  function remplirChoixTuteur(id) {
    $.ajax({
      method: 'GET',
      url: 'suggestTuteur/',
      dataType: 'json',
      data: {
        "id": id
      },
      success: function (data) {
        data.forEach(d => {
          $(`#choix-tut-${id}`).append(`<option data-id=${d.id}>${d.libelle}</option>`);
        });
      },
      error: function (x, error) {
        console.log(error);
      }
    });
  }

  function updateTable() {
    $.ajax({
      method: 'GET',
      url: 'competencesPersonnel/',
      dataType: 'json',
      data: {
        "idPersonnel": Number($('#listePersos option:selected').attr('data-id')),
        "idPoste": Number($('#listePostes option:selected').attr('data-id'))
      },
      success: function (data) {
        $('#tabResulPerso').html("");
        competencesPoste.forEach((p) => {
          var d;
          data.forEach(da => {
            if (p.id == da.id) d = da;
          });
          textToSend = "";
          if (d != null) {
            color = "bg-white";
            if (p.pourcentRequis - d.pourcentAcquis > taux) color = "bg-danger";
            else if (p.pourcentRequis - d.pourcentAcquis <= 0) color = "bg-success";
            textToSend+=`<tr><td class="${color}">${d.libelle} : ${d.pourcentAcquis}%</td>`;
            if (color == "bg-danger") textToSend+=`<td><select id="choix-form-${p.id}"></select></td><td><select id="choix-tut-${p.id}"></select></td></tr>`;
            else textToSend+=`</tr>`
            $('#tabResulPerso').append(textToSend);
          } else {
            $('#tabResulPerso').append(`<tr><td class="bg-danger">${p.libelle} : 0%</td></tr>`);
          }
          remplirChoixFormation(p.id);
          remplirChoixTuteur(p.id);
        });
      },
      error: function (x, error) {
        console.log(error);
      }
    });
  }

  $(document).ready(function () {
    $.ajax({
      method: 'GET',
      url: 'postes/',
      dataType: 'json',
      success: function (data) {
        data.forEach(function (d) {
          $('#listePostes').append(`<option data-id=${d.id}>${d.libelle}</option>`);
        });
      },
      error: function (x, error) {
        console.log(error);
      }
    });
    $.ajax({
      method: 'GET',
      url: 'personnels/',
      dataType: 'json',
      success: function (data) {
        data.forEach(function (d) {
          $('#listePersos').append(`<option data-id=${d.id}>${d.nom}</option>`);
        });
      },
      error: function (x, error) {
        console.log(error);
      }
    });

    $('#listePostes').change(function () {
      $.ajax({
        method: 'GET',
        url: 'competencesPoste/',
        dataType: 'json',
        data: {
          "id": Number($('#listePostes option:selected').attr('data-id'))
        },
        success: function (data) {
          competencesPoste = data
          $('#tabResulPoste').html("");
          data.forEach((d) => {
            $('#tabResulPoste').append(`<tr><td>${d.libelle} : ${d.pourcentRequis}%</td></tr>`);
          });
          if ($('#listePersos option:selected').attr('disabled')) return;
          updateTable();
        },
        error: function (x, error) {
          console.log(error);
        }
      });
    });

    $('#listePersos').change(function () {
      if ($('#listePostes option:selected').attr('disabled')) return;
      updateTable();
    });

    $('#taux').change(function () {
      if ($('#taux').val() == undefined) return;
      taux = Number($('#taux').val());
      if ($('#listePostes option:selected').attr('disabled')) return;
      if ($('#listePersos option:selected').attr('disabled')) return;
      updateTable();
    });
  });
</script>

</html>